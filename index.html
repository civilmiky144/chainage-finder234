<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#004a99">
<title>BPPTPL Site Tracker Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{ --bppt-blue: #004a99; --bppt-green: #28a745; --safety-orange: #FF8C00; --bg: #f4f7f6; }
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{color: #1f2937; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100dvh;}

header {
    background: white; padding: 12px 16px; border-bottom: 4px solid var(--bppt-blue);
    display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0;
}
.logo { height: 48px; width: auto; }
.header-text h1 { margin: 0; font-size: 13px; color: var(--bppt-blue); text-transform: uppercase; line-height: 1.2; }
.header-text p { margin: 1px 0 0 0; font-size: 10px; color: var(--bppt-green); font-weight: bold; }

.scroll-area { flex: 1; overflow-y: auto; padding: 15px; }

.ch-card {
    background: white; border: 1px solid #d1d5db; border-radius: 20px; padding: 25px 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px;
}
.label { font-size: 11px; letter-spacing: 2px; color: #6b7280; margin-bottom: 10px; font-weight: 800; text-transform: uppercase; }
#chValue { font-size: 14vw; font-weight: 900; color: var(--safety-orange); font-family: monospace; }

.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.ibox { background: white; border: 1px solid #d1d5db; padding: 8px; border-radius: 10px; text-align: center; }
.ibox-lbl { font-size: 9px; color: #6b7280; font-weight: bold; }
.ibox-val { font-size: 11px; font-weight: bold; color: var(--bppt-blue); }

.btn { width: 100%; padding: 16px; border-radius: 15px; border: none; font-size: 14px; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-bottom: 10px; }
.btn-primary { background: var(--bppt-blue); color: white; }
.btn-stop { background: #ef4444; color: white; }
.btn-camera { background: #374151; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
.btn-pdf { background: var(--bppt-green); color: white; margin-top: 10px; }

.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
.modal-content { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; }
.modal-h2 { font-size: 18px; margin-bottom: 20px; color: var(--bppt-blue); text-align: center; font-weight: 800; }
.side-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.side-btn { padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; text-align: center;}
.side-btn.active { border-color: var(--bppt-blue); background: #eef2ff; color: var(--bppt-blue); }
.input-field { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 14px; }

footer { padding: 12px; background: white; text-align: center; border-top: 1px solid #e5e7eb; font-size: 11px; }
#cameraInput, #canvasHelper { display: none; }
</style>
</head>
<body onload="checkUser()">

<header>
    <img src="1000678935.png" alt="Logo" class="logo" id="mainLogo">
    <div class="header-text">
        <h1>Beawar Pali Pindwara Tollway</h1>
        <p>MAINTENANCE DEPARTMENT</p>
    </div>
</header>

<div class="scroll-area">
    <div class="ch-card">
        <div class="label">Current Chainage</div>
        <div id="chValue">--+---</div>
    </div>

    <div class="stats-grid">
        <div class="ibox"><div class="ibox-lbl">LATITUDE</div><div class="ibox-val" id="infoLat">--</div></div>
        <div class="ibox"><div class="ibox-lbl">LONGITUDE</div><div class="ibox-val" id="infoLon">--</div></div>
    </div>

    <button class="btn btn-primary" id="btnTrack" onclick="toggleTracking()">Want Your Chainage Click Me</button>
    <input type="file" accept="image/*" capture="camera" id="cameraInput" onchange="openAnnotationModal(event)">
    <button class="btn btn-camera" id="btnCamera" onclick="triggerCamera()" disabled>ðŸ“· Capture Site Photo</button>
    <button class="btn btn-pdf" id="btnSummary" onclick="generatePDF()">ðŸ“„ Generate Visit Summary</button>
</div>

<div class="modal" id="userModal">
    <div class="modal-content">
        <h2 class="modal-h2">User Profile Setup</h2>
        <input type="text" class="input-field" id="userName" placeholder="Full Name">
        <input type="text" class="input-field" id="userDesig" placeholder="Designation (e.g. Sr. Manager)">
        <button class="btn btn-primary" onclick="saveUser()">Save & Start</button>
    </div>
</div>

<div class="modal" id="annotationModal">
    <div class="modal-content">
        <h2 class="modal-h2">Site Observation</h2>
        <div class="side-selector">
            <div class="side-btn" onclick="selectSide('LHS', this)">LHS</div>
            <div class="side-btn" onclick="selectSide('RHS', this)">RHS</div>
            <div class="side-btn" onclick="selectSide('Median', this)">Median</div>
        </div>
        <input type="text" class="input-field" id="customNote" placeholder="Enter note (e.g. Pothole)">
        <button class="btn btn-primary" onclick="finishImageProcessing()">Save & Download</button>
    </div>
</div>

<footer id="appFooter">Prepared by - --</footer>
<canvas id="canvasHelper"></canvas>

<script>
// --- YOUR COORDINATE LIST START ---
const CHAIN_PTS=[
["0+000",26.0617792,74.2991350],
["0+050",26.0619805,74.2986852],
// ... PASTE YOUR REMAINING 4889 POINTS HERE ...
["244+354",24.7800582,73.0298757]
];
// --- YOUR COORDINATE LIST END ---

let isTracking = false, watchId = null, currentCH = "--+---", currentLat = "0", currentLon = "0", selectedSide = "N/A", pendingImageData = null;
let visitLogs = [];
let userProfile = { name: "User", desig: "Engineer" };

// USER LOGIC
function checkUser() {
    const saved = localStorage.getItem("bpptpl_user");
    if(saved) { userProfile = JSON.parse(saved); updateFooter(); } 
    else { document.getElementById("userModal").style.display = "flex"; }
}
function saveUser() {
    userProfile.name = document.getElementById("userName").value;
    userProfile.desig = document.getElementById("userDesig").value;
    if(!userProfile.name) return alert("Enter Name");
    localStorage.setItem("bpptpl_user", JSON.stringify(userProfile));
    document.getElementById("userModal").style.display = "none";
    updateFooter();
}
function updateFooter() { document.getElementById("appFooter").innerHTML = `Prepared by - <strong>${userProfile.name}</strong> (${userProfile.desig})`; }

// MATHEMATICAL DISTANCE LOGIC (FIXED)
function distM(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function findNearest(lat, lon) {
    let minD = Infinity;
    let nearestTag = "--+---";
    for (let i = 0; i < CHAIN_PTS.length; i++) {
        let d = distM(lat, lon, CHAIN_PTS[i][1], CHAIN_PTS[i][2]);
        if (d < minD) { minD = d; nearestTag = CHAIN_PTS[i][0]; }
    }
    return { tag: nearestTag, dist: minD };
}

function toggleTracking() {
    const btn = document.getElementById("btnTrack");
    if (isTracking) {
        navigator.geolocation.clearWatch(watchId); isTracking = false;
        btn.textContent = "Want Your Chainage Click Me";
        btn.className = "btn btn-primary";
        document.getElementById("btnCamera").disabled = true;
    } else {
        isTracking = true;
        btn.textContent = "Stop Tracking";
        btn.className = "btn btn-stop";
        document.getElementById("btnCamera").disabled = false;
        watchId = navigator.geolocation.watchPosition(pos => {
            currentLat = pos.coords.latitude.toFixed(6);
            currentLon = pos.coords.longitude.toFixed(6);
            const res = findNearest(pos.coords.latitude, pos.coords.longitude);
            currentCH = res.tag;
            document.getElementById("chValue").textContent = res.tag;
            document.getElementById("infoLat").textContent = currentLat;
            document.getElementById("infoLon").textContent = currentLon;
        }, err => alert("GPS Error: " + err.message), {enableHighAccuracy: true});
    }
}

// CAMERA & PDF LOGIC
function triggerCamera() { document.getElementById("cameraInput").click(); }
function selectSide(side, el) { 
    selectedSide = side; 
    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}
function openAnnotationModal(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => { pendingImageData = e.target.result; document.getElementById("annotationModal").style.display = "flex"; };
    reader.readAsDataURL(file);
}

function finishImageProcessing() {
    const note = document.getElementById("customNote").value || "N/A";
    const ts = new Date().toLocaleString();
    visitLogs.push({ ch: currentCH, side: selectedSide, note: note, lat: currentLat, lon: currentLon, time: ts });
    const img = new Image();
    img.onload = function() {
        const canvas = document.getElementById("canvasHelper");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width; canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const f = Math.floor(canvas.width / 25);
        ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0, canvas.height-(f*5.5), canvas.width, f*5.5);
        ctx.fillStyle = "white"; ctx.font = `bold ${f}px Arial`;
        ctx.fillText(`CH: ${currentCH} (${selectedSide})`, 30, canvas.height-(f*3.8));
        ctx.font = `${f*0.7}px Arial`;
        ctx.fillText(`Note: ${note} | GPS: ${currentLat}, ${currentLon}`, 30, canvas.height-(f*2.4));
        ctx.fillText(`By: ${userProfile.name} | ${ts}`, 30, canvas.height-(f*1.0));
        const logoImg = document.getElementById("mainLogo");
        const lW = canvas.width * 0.12; const lH = (logoImg.naturalHeight / logoImg.naturalWidth) * lW;
        ctx.drawImage(logoImg, canvas.width - lW - 30, 30, lW, lH);
        const link = document.createElement('a'); link.download = `Site_${currentCH}.jpg`;
        link.href = canvas.toDataURL("image/jpeg", 0.8); link.click();
        document.getElementById("annotationModal").style.display = "none";
        document.getElementById("customNote").value = "";
    };
    img.src = pendingImageData;
}

function generatePDF() {
    if (visitLogs.length === 0) return alert("Capture photos first!");
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.setFontSize(18); doc.text("BPPTPL SITE VISIT SUMMARY", 14, 20);
    doc.setFontSize(10); doc.text(`By: ${userProfile.name} | Date: ${new Date().toLocaleDateString()}`, 14, 28);
    let y = 40;
    visitLogs.forEach((log, i) => {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont(undefined, 'bold'); doc.text(`${i+1}. CH: ${log.ch} (${log.side})`, 14, y);
        doc.setFont(undefined, 'normal'); doc.text(`Note: ${log.note}`, 14, y+6);
        doc.text(`GPS: ${log.lat}, ${log.lon} | Time: ${log.time}`, 14, y+11);
        y += 20;
    });
    doc.save(`${userProfile.name}_Report.pdf`);
}
</script>
</body>
</html>
