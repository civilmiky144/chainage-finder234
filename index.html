<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#004a99">
<title>BPPTPL Site Tracker Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{ --bppt-blue: #004a99; --bppt-green: #28a745; --orange: #FF8C00; --bg: #f4f7f6; }
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{color:#1f2937; font-family:sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100dvh; overflow:hidden;}

header {
    background:white; padding:12px; border-bottom:4px solid var(--bppt-blue);
    display:flex; flex-direction:row; align-items:center; justify-content:center; gap:12px; box-shadow:0 2px 4px rgba(0,0,0,0.1); flex-shrink:0;
}
.logo { height:45px; width:auto; }
.header-text h1 { margin:0; font-size:13px; color:var(--bppt-blue); text-transform:uppercase; }
.header-text p { margin:0; font-size:10px; color:var(--bppt-green); font-weight:bold; }

.scroll-area { flex:1; overflow-y:auto; padding:15px; padding-bottom:80px; }

.ch-card {
    background:white; border:1px solid #ddd; border-radius:20px; padding:25px 10px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:15px;
}
.label { font-size:10px; letter-spacing:2px; color:#666; margin-bottom:10px; font-weight:bold; text-transform:uppercase; }
#chValue { font-size:14vw; font-weight:900; color:var(--orange); font-family:monospace; }

.section-card { background:#eef2ff; border:1px solid #c7d2fe; border-radius:15px; padding:12px; margin-bottom:15px; display:none; }
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; }
.ibox { background:white; border:1px solid #ddd; padding:8px; border-radius:10px; text-align:center; }
.ibox-lbl { font-size:8px; color:#888; font-weight:bold; }
.ibox-val { font-size:11px; font-weight:bold; color:var(--bppt-blue); }

.btn { width:100%; padding:16px; border-radius:12px; border:none; font-size:13px; font-weight:bold; text-transform:uppercase; cursor:pointer; margin-bottom:10px; }
.btn-primary { background:var(--bppt-blue); color:white; }
.btn-stop { background:#ef4444; color:white; }
.btn-camera { background:#374151; color:white; }

.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:20px; }
.modal-content { background:white; width:100%; max-width:400px; border-radius:20px; padding:20px; }
.side-selector { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px; }
.side-btn { padding:12px; border:1px solid #ddd; border-radius:8px; font-size:12px; cursor:pointer; text-align:center; font-weight:bold; }
.side-btn.active { background:var(--bppt-blue); color:white; border-color:var(--bppt-blue); }

footer { position:fixed; bottom:0; width:100%; padding:10px; background:white; text-align:center; border-top:1px solid #eee; font-size:11px; }
#cameraInput, #canvasHelper { display:none; }
</style>
</head>
<body onload="checkUser()">

<header>
    <img src="1000678935.png" alt="Logo" class="logo" id="mainLogo">
    <div class="header-text">
        <h1>Beawar Pali Pindwara Tollway</h1>
        <p>MAINTENANCE DEPARTMENT</p>
    </div>
</header>

<div class="scroll-area">
    <div class="ch-card">
        <div class="label">Current Chainage</div>
        <div id="chValue">--+---</div>
    </div>

    <div class="section-card" id="sectionCard">
        <div style="font-weight:bold; color:var(--bppt-blue); margin-bottom:5px;" id="secTitle">SECTION --</div>
        <div style="font-size:12px">In-charge: <strong id="secName">--</strong></div>
        <div id="secPhone" style="font-size:13px; font-weight:bold; margin-top:5px;">&#9742; --</div>
    </div>

    <div class="stats-grid">
        <div class="ibox"><div class="ibox-lbl">LATITUDE</div><div class="ibox-val" id="infoLat">--</div></div>
        <div class="ibox"><div class="ibox-lbl">LONGITUDE</div><div class="ibox-val" id="infoLon">--</div></div>
    </div>

    <button class="btn btn-primary" id="btnTrack" onclick="toggleTracking()">Want Your Chainage Click Me</button>
    <input type="file" accept="image/*" capture="camera" id="cameraInput" onchange="openAnnotationModal(event)">
    <button class="btn btn-camera" id="btnCamera" onclick="triggerCamera()" disabled>ðŸ“· Capture Site Photo</button>
    <button class="btn" style="background:var(--bppt-green); color:white;" onclick="generatePDF()">ðŸ“„ Visit Summary PDF</button>
</div>

<div class="modal" id="annotationModal">
    <div class="modal-content">
        <h3 style="margin-bottom:15px; text-align:center;">Site Details</h3>
        <div class="side-selector">
            <div class="side-btn" onclick="selectSide('LHS', this)">LHS</div>
            <div class="side-btn" onclick="selectSide('RHS', this)">RHS</div>
            <div class="side-btn" onclick="selectSide('Median', this)">Median</div>
        </div>
        <input type="text" id="customNote" placeholder="Enter note (e.g. Guardrail damage)" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <button class="btn btn-primary" id="btnFinalSave" onclick="finishImageProcessing()">Save Photo</button>
    </div>
</div>

<div class="modal" id="userModal">
    <div class="modal-content">
        <h3 style="margin-bottom:15px; text-align:center;">User Setup</h3>
        <input type="text" id="userName" placeholder="Your Full Name" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="text" id="userDesig" placeholder="Designation" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <button class="btn btn-primary" onclick="saveUser()">Save & Start</button>
    </div>
</div>

<footer id="appFooter">Prepared by - --</footer>
<canvas id="canvasHelper"></canvas>

<script>
// --- PASTE YOUR 4889 POINTS HERE ---
const CHAIN_PTS=[ ["0+000",26.0617792,74.2991350], ["244+354",24.7800582,73.0298757] ];

const SECTION_DATA = {
    1: { name: "Mr. Sachin Gupta", phone: "8506878948" },
    2: { name: "Mr. Amit Khemwani", phone: "6375884003" },
    3: { name: "Section Incharge", phone: "9529826416" },
    4: { name: "Mr. Bhagwat Rathore", phone: "8619494508" }
};

let isTracking = false, watchId = null, currentCH = "--+---", currentLat = "", currentLon = "", selectedSide = "N/A", pendingImageData = null;
let visitLogs = [], userProfile = { name: "", desig: "" };

function checkUser() {
    const saved = localStorage.getItem("bpptpl_user");
    if(saved) { userProfile = JSON.parse(saved); updateFooter(); } 
    else { document.getElementById("userModal").style.display = "flex"; }
}
function saveUser() {
    userProfile.name = document.getElementById("userName").value;
    userProfile.desig = document.getElementById("userDesig").value;
    if(!userProfile.name) return alert("Enter Name");
    localStorage.setItem("bpptpl_user", JSON.stringify(userProfile));
    document.getElementById("userModal").style.display = "none";
    updateFooter();
}
function updateFooter() { document.getElementById("appFooter").innerHTML = `Prepared by - <strong>${userProfile.name}</strong> (${userProfile.desig})`; }

// ROCK SOLID CHAINAGE LOGIC
function toggleTracking() {
    const btn = document.getElementById("btnTrack");
    if (isTracking) {
        navigator.geolocation.clearWatch(watchId); isTracking = false;
        btn.textContent = "Want Your Chainage Click Me"; btn.className = "btn btn-primary";
        document.getElementById("btnCamera").disabled = true;
    } else {
        isTracking = true;
        btn.textContent = "Stop Tracking"; btn.className = "btn btn-stop";
        document.getElementById("btnCamera").disabled = false;
        watchId = navigator.geolocation.watchPosition(pos => {
            currentLat = pos.coords.latitude.toFixed(6);
            currentLon = pos.coords.longitude.toFixed(6);
            
            // FAST LOOKUP
            let minD = Infinity;
            for (let pt of CHAIN_PTS) {
                let d = Math.sqrt(Math.pow(pos.coords.latitude - pt[1], 2) + Math.pow(pos.coords.longitude - pt[2], 2));
                if (d < minD) { minD = d; currentCH = pt[0]; }
            }
            document.getElementById("chValue").textContent = currentCH;
            document.getElementById("infoLat").textContent = currentLat;
            document.getElementById("infoLon").textContent = currentLon;
            
            // SECTION UPDATE
            const km = parseInt(currentCH.split('+')[0]);
            let sNum = km >= 180 ? 4 : km >= 120 ? 3 : km >= 60 ? 2 : 1;
            const sData = SECTION_DATA[sNum];
            document.getElementById("sectionCard").style.display = "block";
            document.getElementById("secTitle").textContent = "SECTION " + sNum;
            document.getElementById("secName").textContent = sData.name;
            document.getElementById("secPhone").textContent = "\u260E " + sData.phone;
        }, null, {enableHighAccuracy: true});
    }
}

// MEMORY-SAFE CAMERA LOGIC
function triggerCamera() { document.getElementById("cameraInput").click(); }
function selectSide(side, el) { 
    selectedSide = side; 
    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}
function openAnnotationModal(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => { pendingImageData = event.target.result; document.getElementById("annotationModal").style.display = "flex"; };
    reader.readAsDataURL(file);
}

function finishImageProcessing() {
    const btn = document.getElementById("btnFinalSave");
    btn.disabled = true; btn.textContent = "Processing...";
    const note = document.getElementById("customNote").value || "N/A";
    const ts = new Date().toLocaleString();
    
    const img = new Image();
    img.onload = function() {
        const canvas = document.getElementById("canvasHelper");
        const ctx = canvas.getContext("2d");
        
        // LIMIT SIZE TO PREVENT CRASH
        const scale = Math.min(1.0, 1600 / img.width);
        canvas.width = img.width * scale; canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const h = canvas.height; const w = canvas.width; const f = Math.floor(w / 30);
        ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0, h-(f*5), w, f*5);
        ctx.fillStyle = "white"; ctx.font = `bold ${f}px Arial`;
        ctx.fillText(`CH: ${currentCH} (${selectedSide})`, 20, h-(f*3.2));
        ctx.font = `${f*0.7}px Arial`;
        ctx.fillText(`Note: ${note} | GPS: ${currentLat}, ${currentLon}`, 20, h-(f*2.0));
        ctx.fillText(`By: ${userProfile.name} | ${ts}`, 20, h-(f*0.8));

        const logoImg = document.getElementById("mainLogo");
        const lW = w * 0.12; const lH = (logoImg.naturalHeight/logoImg.naturalWidth)*lW;
        ctx.drawImage(logoImg, w-lW-20, 20, lW, lH);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
        const link = document.createElement('a');
        link.download = `Site_${currentCH.replace('+','_')}.jpg`;
        link.href = dataUrl;
        link.click();

        visitLogs.push({ ch: currentCH, side: selectedSide, note: note, lat: currentLat, lon: currentLon, time: ts });
        document.getElementById("annotationModal").style.display = "none";
        document.getElementById("customNote").value = "";
        btn.disabled = false; btn.textContent = "Save Photo";
    };
    img.src = pendingImageData;
}

function generatePDF() {
    if (visitLogs.length === 0) return alert("No logs recorded");
    const { jsPDF } = window.jspdf; const doc = new jsPDF();
    doc.text("BPPTPL VISIT SUMMARY", 14, 20);
    doc.setFontSize(10); doc.text(`By: ${userProfile.name} | Date: ${new Date().toLocaleDateString()}`, 14, 28);
    let y = 40;
    visitLogs.forEach((l, i) => {
        if(y > 270) { doc.addPage(); y = 20; }
        doc.text(`${i+1}. CH: ${l.ch} (${l.side}) | Note: ${l.note}`, 14, y);
        y += 10;
    });
    doc.save(`Summary_${userProfile.name}.pdf`);
}
</script>
</body>
</html>
